# 계약에 의한 디자인

컴포넌트는 기능을 숨겨 캡슐화하고 함수를 사용할 Client에게는 API를 노출해야 한다. 컴포넌트의 함수, 클래스, 메서드는 특별한 규칙에 따라 동작해야 하면 그렇지 않을 경우 error가 발생한다. 반대로 호출하는 클라이언트는 특정 응답을 기대하며 이것과 다른 경우 함수 호출에 실패하게된다.

API를 디자인할 때 코드가 정상적으로 동작하기위해 기대하는 것과 클라이언트가 반환 받기를 기대하는 것은 디자인의 하나가 되어야 하는데, 이것을 **계약(contract)**이라고 한다.

계약에 의한 디자인이란 이렇게 양 측이 동의하는 계약을 하고 계약을 어겼을 경우엔 명시적으로 왜 계속할 수 없는지 예외를 발생시키라는 것이다. (쉽게 말해 기대하지 않은 값에 대해서도 설명을 해야한다는 것)

계약은 주로 사전조건/ 사후조건을 명시하지만 때로는 불변식/부작용을 기술한다.

- 사전조건(precondition) : 코드가 실행되기 전에 체크해야 하는 것들이다. 일반적으로 파라미터의 유효성을 검사하지만 데이터베이스, 파일, 이전에 호출된 다른 메서드 검사 등이 있다. 이 작업은 **호출자**가 해야하는 임무이다.
- 사후조건(postcondition) : 사전조건과 반대로 함수 반환 값의 유효성 검사가 수행된다. 호출자가 이 컴포넌트에서 기대한 것을 제대로 받았는지 확인하기 위해 수행한다.
- 불변식 : 함수가 실행되는 동안 일정하게 유지되는 것으로 함수의 로직에 문제가 없는지 확인하기 위한 것이다.
- 부작용 : 선택적으로 코드의 부작용을 docstring에 언급하기도 한다.

위의 4가지를 모두 문서화하면 좋지만 사전조건과 사후조건은 저수준 레벨에서 강제한다.

사전조건과 사후조건을 통해 책임 소재를 신속하게 파악할 수 있다. 사전 조건 검증에 실패하면 클라이언트의 결함에 의한 것이다. 반면 사후조건 검증에 실패하면 특정 모듈이나 제공 클래스 자체에 문제가 있음을 알 수 있다.

특히 사전조건은 런타임 중에 확인할 수 있다는 것을 기억해야한다. 사전조건에 맞지 않으면 실행하지 않아야 한다.

### 사전조건

함수나 메서드가 제대로 동작하기 위해 보장해야 하는 모든 것을 말한다. 예를 들어 초기화된 객체, null이 아닌 값 등의 조건이다. 특히 파이썬은 동적으로 타입이 결정되어 전달된 데이터가 적절한 타입인지 확인하는 경우도 있다.

문제는 이 유효성 검사를 어디서 할지이다. 클라이언트가 함수를 호출하기 전 모든 유효성 검사를 하도록 할 것인지, 함수가 자체적으로 로직을 실행하기 전에 검사하도록 할 것인지에 관한 것이다. 일반적으로 후자의 까다로운 방법이 쓰인다. 

### 사후조건

사후조건은 메서드 또는 함수가 반환된 후의 상태를 강제하는 계약이다.

함수 또는 메서드의 사전조건에 맞는다면 사후조건은 특정 속성이 보장되어야 한다. 사후조건을 사용해 클라이언트가 필요로하는 모든 것을 검사할 수 있다.



### 파이썬스러운 계약

PEP를 적용하는 가장 좋은 방법은 코드에 RuntimeError, ValueError 예외를 발생시키는 제어 메커니즘을 추가하고 일반적인 예외로 특정하기 어렵다면 사용자 정의 예외를 만드는 것이 좋다. 



+팁!

Mypy도구를 사용해보자

